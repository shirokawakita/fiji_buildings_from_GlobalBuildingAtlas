<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fijiå»ºç‰©ãƒãƒªã‚´ãƒ³åœ°å›³ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .file-drop-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: white;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-drop-area:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .file-drop-area.dragover {
            background: #e8e8ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .file-drop-area input[type="file"] {
            display: none;
        }

        .file-drop-area label {
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
        }

        .file-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .file-info strong {
            color: #667eea;
        }

        .controls {
            margin-top: 1.5rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .control-group .value-display {
            font-size: 0.85rem;
            color: #666;
            text-align: right;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
        }

        .status-message {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.9rem;
            display: none;
        }

        .status-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .status-message.success {
            border-left: 4px solid #28a745;
        }

        .status-message.error {
            border-left: 4px solid #dc3545;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .legend {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 1rem;
        }

        .legend h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
            margin-right: 0.5rem;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 300px;
            }

            .header h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ Fijiå»ºç‰©ãƒãƒªã‚´ãƒ³åœ°å›³ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
        <p>GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="file-drop-area" id="dropArea">
                <input type="file" id="fileInput" accept=".geojson,.json">
                <label for="fileInput">
                    ğŸ“ GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’<br>
                    ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯<br>
                    ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
                </label>
                <div class="file-info" id="fileInfo" style="display: none;">
                    <strong>èª­ã¿è¾¼ã¿æ¸ˆã¿:</strong> <span id="fileName"></span><br>
                    <strong>å»ºç‰©æ•°:</strong> <span id="buildingCount">0</span>ä»¶
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>ç·šã®è‰²:</label>
                    <input type="color" id="strokeColor" value="#667eea">
                </div>

                <div class="control-group">
                    <label>å¡—ã‚Šã¤ã¶ã—ã®è‰²:</label>
                    <input type="color" id="fillColor" value="#ffd700">
                </div>

                <div class="control-group">
                    <label>ç·šã®é€æ˜åº¦:</label>
                    <input type="range" id="strokeOpacity" min="0" max="1" step="0.1" value="0.8">
                    <div class="value-display" id="strokeOpacityValue">80%</div>
                </div>

                <div class="control-group">
                    <label>å¡—ã‚Šã¤ã¶ã—ã®é€æ˜åº¦:</label>
                    <input type="range" id="fillOpacity" min="0" max="1" step="0.1" value="0.3">
                    <div class="value-display" id="fillOpacityValue">30%</div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="zoomToBuildings()">ğŸ  å»ºç‰©ç¯„å›²ã«ã‚ºãƒ¼ãƒ </button>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="zoomToFiji()">ğŸ—ºï¸ Fijiå…¨ä½“ã«ã‚ºãƒ¼ãƒ </button>
                </div>

                <div class="button-group">
                    <button class="btn-danger" onclick="clearMap()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="legend">
                <h3>å‡¡ä¾‹</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffd700; opacity: 0.3;"></div>
                    <span>å»ºç‰©ãƒãƒªã‚´ãƒ³</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="map"></div>
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // åœ°å›³ã®åˆæœŸåŒ–
        const map = L.map('map').setView([-17.8, 178.4], 10);

        // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // GeoJSONãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let geoJsonLayer = null;

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®è¨­å®š
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const buildingCount = document.getElementById('buildingCount');
        const statusMessage = document.getElementById('statusMessage');

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // GeoJSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
        function calculateBounds(geoJsonData) {
            if (!geoJsonData.features || geoJsonData.features.length === 0) {
                return null;
            }

            let minLat = Infinity;
            let maxLat = -Infinity;
            let minLng = Infinity;
            let maxLng = -Infinity;

            const processCoordinates = (coords) => {
                if (!Array.isArray(coords)) {
                    return;
                }
                
                // åº§æ¨™ãŒæ•°å€¤ã®é…åˆ—ã‹ãƒã‚§ãƒƒã‚¯ [lng, lat]
                if (coords.length >= 2 && typeof coords[0] === 'number' && typeof coords[1] === 'number') {
                    const [lng, lat] = coords;
                    if (!isNaN(lat) && !isNaN(lng)) {
                        minLat = Math.min(minLat, lat);
                        maxLat = Math.max(maxLat, lat);
                        minLng = Math.min(minLng, lng);
                        maxLng = Math.max(maxLng, lng);
                    }
                    return;
                }
                
                // é…åˆ—ã®é…åˆ—ã®å ´åˆã¯å†å¸°çš„ã«å‡¦ç†
                if (Array.isArray(coords[0])) {
                    coords.forEach(coord => processCoordinates(coord));
                }
            };

            geoJsonData.features.forEach(feature => {
                if (!feature.geometry || !feature.geometry.coordinates) {
                    return;
                }

                const geomType = feature.geometry.type;
                const coords = feature.geometry.coordinates;

                if (geomType === 'Point') {
                    processCoordinates(coords);
                } else if (geomType === 'Polygon') {
                    // Polygon: coordinates[0] ãŒå¤–å´ã®ãƒªãƒ³ã‚°
                    if (coords[0] && Array.isArray(coords[0])) {
                        coords[0].forEach(coord => processCoordinates(coord));
                    }
                } else if (geomType === 'MultiPolygon') {
                    // MultiPolygon: coordinates[0][0] ãŒæœ€åˆã®ãƒãƒªã‚´ãƒ³ã®å¤–å´ã®ãƒªãƒ³ã‚°
                    coords.forEach(polygon => {
                        if (polygon[0] && Array.isArray(polygon[0])) {
                            polygon[0].forEach(coord => processCoordinates(coord));
                        }
                    });
                } else {
                    // ãã®ä»–ã®ã‚¿ã‚¤ãƒ—ã¯å†å¸°çš„ã«å‡¦ç†
                    processCoordinates(coords);
                }
            });

            if (minLat === Infinity || maxLat === -Infinity || minLng === Infinity || maxLng === -Infinity) {
                return null;
            }

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒæœ‰åŠ¹ã‹ç¢ºèª
            if (minLat >= maxLat || minLng >= maxLng) {
                return null;
            }

            // æ—¥ä»˜å¤‰æ›´ç·šã‚’è·¨ãå ´åˆã®å‡¦ç†ï¼ˆçµŒåº¦ãŒ180åº¦ã‚’è·¨ã„ã§ã„ã‚‹å ´åˆï¼‰
            // ä¾‹: -179.97Â° ï½ 179.99Â° ã®ã‚ˆã†ãªå ´åˆ
            if (maxLng - minLng > 180) {
                // æ—¥ä»˜å¤‰æ›´ç·šã‚’è·¨ã„ã§ã„ã‚‹å ´åˆã€2ã¤ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã«åˆ†å‰²
                // ã¾ãŸã¯ã€ä¸­å¿ƒåº§æ¨™ã¨ã‚µã‚¤ã‚ºã‹ã‚‰ç›´æ¥è¨ˆç®—
                const centerLng = (minLng + maxLng) / 2;
                // ä¸­å¿ƒãŒ180åº¦ã‚’è·¨ã„ã§ã„ã‚‹å ´åˆã€æ­£è¦åŒ–
                let normalizedCenterLng = centerLng;
                if (centerLng > 180) normalizedCenterLng -= 360;
                if (centerLng < -180) normalizedCenterLng += 360;
                
                // å®Ÿéš›ã®ç¯„å›²ã‚’è¨ˆç®—ï¼ˆæ—¥ä»˜å¤‰æ›´ç·šã‚’è·¨ãéƒ¨åˆ†ã‚’è€ƒæ…®ï¼‰
                const lngRange1 = 180 - minLng; // è¥¿å´ã®ç¯„å›²
                const lngRange2 = maxLng - (-180); // æ±å´ã®ç¯„å›²
                const actualLngRange = Math.max(lngRange1, lngRange2);
                
                // ä¸­å¿ƒåº§æ¨™ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
                const centerLat = (minLat + maxLat) / 2;
                const latRange = maxLat - minLat;
                
                // ä¸­å¿ƒã‚’åŸºæº–ã«ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
                return L.latLngBounds(
                    [centerLat - latRange / 2, normalizedCenterLng - actualLngRange / 2],
                    [centerLat + latRange / 2, normalizedCenterLng + actualLngRange / 2]
                );
            }

            return L.latLngBounds(
                [minLat, minLng],
                [maxLat, maxLng]
            );
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†é–¢æ•°
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.geojson') && !file.name.toLowerCase().endsWith('.json')) {
                showStatus('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const geoJsonData = JSON.parse(e.target.result);
                    
                    // æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
                    if (geoJsonLayer) {
                        map.removeLayer(geoJsonLayer);
                    }

                    // GeoJSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                    const calculatedBounds = calculateBounds(geoJsonData);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’æ›´æ–°
                    fileName.textContent = file.name;
                    const featureCount = geoJsonData.features ? geoJsonData.features.length : 0;
                    buildingCount.textContent = featureCount.toLocaleString();
                    fileInfo.style.display = 'block';

                    // GeoJSONãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
                    geoJsonLayer = L.geoJSON(geoJsonData, {
                        style: getStyle,
                        onEachFeature: onEachFeature
                    });

                    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
                    geoJsonLayer.addTo(map);

                    // ã‚ºãƒ¼ãƒ å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆFijiã®ä¸­å¿ƒåº§æ¨™ã‚’ä½¿ç”¨ï¼‰
                    const performZoom = () => {
                        let boundsToUse = null;
                        
                        // æ–¹æ³•1: è¨ˆç®—ã—ãŸãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
                        if (calculatedBounds && calculatedBounds.isValid()) {
                            boundsToUse = calculatedBounds;
                        } 
                        // æ–¹æ³•2: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å–å¾—
                        else {
                            try {
                                const layerBounds = geoJsonLayer.getBounds();
                                if (layerBounds && layerBounds.isValid()) {
                                    boundsToUse = layerBounds;
                                }
                            } catch (e) {
                                // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                            }
                        }

                        // Fijiã®ä¸­å¿ƒåº§æ¨™ï¼ˆSuvaå‘¨è¾ºï¼‰ã‚’ç›´æ¥ä½¿ç”¨
                        const fijiCenter = L.latLng(-17.8, 178.4);
                        let calculatedZoom = 9;
                        
                        if (boundsToUse && boundsToUse.isValid()) {
                            const sw = boundsToUse.getSouthWest();
                            const ne = boundsToUse.getNorthEast();
                            
                            // ç·¯åº¦ç¯„å›²ã‹ã‚‰é©åˆ‡ãªã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
                            const latRange = ne.lat - sw.lat;
                            if (latRange > 3) calculatedZoom = 7;
                            else if (latRange > 2) calculatedZoom = 8;
                            else if (latRange > 1) calculatedZoom = 9;
                            else if (latRange > 0.5) calculatedZoom = 10;
                            else if (latRange > 0.2) calculatedZoom = 11;
                            else calculatedZoom = 12;
                        }
                        
                        // ç›´æ¥ã‚ºãƒ¼ãƒ 
                        map.setView(fijiCenter, calculatedZoom, { animate: false });
                        
                        showStatus(`${featureCount.toLocaleString()}ä»¶ã®å»ºç‰©ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                    };

                    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Œå…¨ã«è¿½åŠ ãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
                    setTimeout(() => {
                        performZoom();
                    }, 300);
                } catch (error) {
                    showStatus('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                    console.error(error);
                }
            };

            reader.onerror = () => {
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            };

            reader.readAsText(file);
        }

        // ã‚¹ã‚¿ã‚¤ãƒ«é–¢æ•°
        function getStyle(feature) {
            const strokeColor = document.getElementById('strokeColor').value;
            const fillColor = document.getElementById('fillColor').value;
            const strokeOpacity = parseFloat(document.getElementById('strokeOpacity').value);
            const fillOpacity = parseFloat(document.getElementById('fillOpacity').value);

            return {
                color: strokeColor,
                weight: 1,
                opacity: strokeOpacity,
                fillColor: fillColor,
                fillOpacity: fillOpacity
            };
        }

        // å„ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã«å¯¾ã™ã‚‹å‡¦ç†
        function onEachFeature(feature, layer) {
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            if (feature.properties) {
                let popupContent = '<div style="font-size: 0.9rem;">';
                
                if (feature.properties.id) {
                    popupContent += `<strong>ID:</strong> ${feature.properties.id}<br>`;
                }
                
                if (feature.properties.scores) {
                    popupContent += `<strong>ã‚¹ã‚³ã‚¢:</strong> ${feature.properties.scores}<br>`;
                }

                // ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤º
                for (const key in feature.properties) {
                    if (key !== 'id' && key !== 'scores') {
                        popupContent += `<strong>${key}:</strong> ${feature.properties[key]}<br>`;
                    }
                }

                popupContent += '</div>';
                layer.bindPopup(popupContent);
            }

            // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            layer.on({
                mouseover: function(e) {
                    const layer = e.target;
                    layer.setStyle({
                        weight: 2,
                        fillOpacity: 0.5
                    });
                },
                mouseout: function(e) {
                    geoJsonLayer.resetStyle(e.target);
                }
            });
        }

        // ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°é–¢æ•°
        function updateStyle() {
            if (geoJsonLayer) {
                geoJsonLayer.setStyle(getStyle);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
        document.getElementById('strokeColor').addEventListener('change', updateStyle);
        document.getElementById('fillColor').addEventListener('change', updateStyle);
        document.getElementById('strokeOpacity').addEventListener('input', (e) => {
            document.getElementById('strokeOpacityValue').textContent = Math.round(e.target.value * 100) + '%';
            updateStyle();
        });
        document.getElementById('fillOpacity').addEventListener('input', (e) => {
            document.getElementById('fillOpacityValue').textContent = Math.round(e.target.value * 100) + '%';
            updateStyle();
        });

        // ã‚ºãƒ¼ãƒ é–¢æ•°
        function zoomToBuildings() {
            if (!geoJsonLayer) {
                showStatus('å»ºç‰©ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåœ°å›³ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!map.hasLayer(geoJsonLayer)) {
                    showStatus('å»ºç‰©ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåœ°å›³ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }

                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—
                const bounds = geoJsonLayer.getBounds();
                
                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒæœ‰åŠ¹ã‹ç¢ºèª
                if (!bounds || !bounds.isValid()) {
                    showStatus('å»ºç‰©ã®ç¯„å›²ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    return;
                }

                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºã‚’ç¢ºèª
                const latDiff = bounds.getNorth() - bounds.getSouth();
                const lngDiff = bounds.getEast() - bounds.getWest();
                
                if (latDiff === 0 && lngDiff === 0) {
                    showStatus('å»ºç‰©ãŒ1ç‚¹ã«é›†ä¸­ã—ã¦ã„ã¾ã™', 'error');
                    return;
                }

                // æ—¥ä»˜å¤‰æ›´ç·šã‚’è·¨ãå ´åˆã®æ¤œå‡º
                const isCrossingDateline = lngDiff > 180 || (bounds.getWest() < 0 && bounds.getEast() > 0);
                
                if (isCrossingDateline) {
                    // Fijiã®ä¸­å¿ƒåº§æ¨™ã‚’ä½¿ç”¨
                    const fijiCenter = L.latLng(-17.8, 178.4);
                    
                    // ç·¯åº¦ç¯„å›²ã‹ã‚‰é©åˆ‡ãªã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
                    let calculatedZoom = 9;
                    if (latDiff > 3) calculatedZoom = 7;
                    else if (latDiff > 2) calculatedZoom = 8;
                    else if (latDiff > 1) calculatedZoom = 9;
                    else if (latDiff > 0.5) calculatedZoom = 10;
                    else if (latDiff > 0.2) calculatedZoom = 11;
                    else calculatedZoom = 12;
                    
                    // ç›´æ¥ã‚ºãƒ¼ãƒ 
                    map.setView(fijiCenter, calculatedZoom, { animate: true });
                    
                    showStatus('å»ºç‰©ç¯„å›²ã«ã‚ºãƒ¼ãƒ ã—ã¾ã—ãŸ', 'success');
                } else {
                    // é€šå¸¸ã®å‡¦ç†
                    // åœ°å›³ã®ç¯„å›²ã«ã‚ºãƒ¼ãƒ 
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        maxZoom: 15,
                        animate: true,
                        duration: 0.5
                    });
                    
                    showStatus('å»ºç‰©ç¯„å›²ã«ã‚ºãƒ¼ãƒ ã—ã¾ã—ãŸ', 'success');
                }
            } catch (error) {
                console.error('ã‚ºãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ã‚ºãƒ¼ãƒ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function zoomToFiji() {
            map.setView([-17.8, 178.4], 7);
            showStatus('Fijiå…¨ä½“ã«ã‚ºãƒ¼ãƒ ã—ã¾ã—ãŸ', 'success');
        }

        function clearMap() {
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
                geoJsonLayer = null;
                fileInfo.style.display = 'none';
                fileName.textContent = '';
                buildingCount.textContent = '0';
                showStatus('åœ°å›³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        showStatus('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'success');
    </script>
</body>
</html>

